<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Passkey 示例</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 100px;
        }
        button {
            padding: 15px 30px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #output {
            margin-top: 20px;
            white-space: pre-wrap;
            text-align: left;
            display: inline-block;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <h1>Passkey 演示</h1>
    <button id="create-passkey">创建 Passkey</button>
    <button id="verify-passkey">验证 Passkey</button>
    <div id="output"></div>

    <script>
        // 获取 DOM 元素
        const createBtn = document.getElementById('create-passkey');
        const verifyBtn = document.getElementById('verify-passkey');
        const outputDiv = document.getElementById('output');

        // 辅助函数：生成随机字节
        function bufferToBase64(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function base64ToBuffer(base64) {
            const padding = '='.repeat((4 - base64.length % 4) % 4);
            const base64Safe = (base64 + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            return Uint8Array.from(atob(base64Safe), c => c.charCodeAt(0));
        }

        // 创建 Passkey
        createBtn.addEventListener('click', async () => {
            outputDiv.textContent = '创建 Passkey 中...';
            try {
                const publicKey = {
                    challenge: base64ToBuffer(generateRandomBase64(32)),
                    rp: {
                        name: 'chengjunjie.com'
                    },
                    user: {
                        id: base64ToBuffer(generateRandomBase64(16)),
                        name: 'user@chengjunjie.com',
                        displayName: '用户'
                    },
                    pubKeyCredParams: [
                        { type: 'public-key', alg: -7 },  // ES256
                        { type: 'public-key', alg: -257 } // RS256
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: 'platform',
                        userVerification: 'preferred'
                    },
                    timeout: 60000,
                    attestation: 'direct'
                };

                const credential = await navigator.credentials.create({ publicKey });

                // // 存储凭证信息到 localStorage
                // const credId = bufferToBase64(credential.id);
                // const publicKeyJwk = await crypto.subtle.exportKey('jwk', credential.publicKey);

                // const storedCredentials = JSON.parse(localStorage.getItem('credentials') || '[]');
                // storedCredentials.push({
                //     id: credId,
                //     publicKey: publicKeyJwk
                // });
                // localStorage.setItem('credentials', JSON.stringify(storedCredentials));

                outputDiv.textContent = 'Passkey 创建成功！\n凭证 ID: ';
            } catch (err) {
                console.error(err);
                outputDiv.textContent = '创建 Passkey 失败：' + err.message;
            }
        });

        // 验证 Passkey
        verifyBtn.addEventListener('click', async () => {
            outputDiv.textContent = '验证 Passkey 中...';
            try {
                // const storedCredentials = JSON.parse(localStorage.getItem('credentials') || '[]');
                // if (storedCredentials.length === 0) {
                //     outputDiv.textContent = '没有可用的 Passkey，请先创建一个。';
                //     return;
                // }

                const publicKey = {
                    challenge: base64ToBuffer(generateRandomBase64(32)),
                    timeout: 60000,
                    // allowCredentials: storedCredentials.map(cred => ({
                    //     type: 'public-key',
                    //     id: base64ToBuffer(cred.id)
                    // })),
                    userVerification: 'preferred'
                };

                const assertion = await navigator.credentials.get({ publicKey });
                outputDiv.textContent = 'Passkey 验证成功！\n凭证 ID: ';

                // // 简单验证：检查凭证 ID 是否存在
                // const assertionId = bufferToBase64(assertion.id);
                // const credentialExists = storedCredentials.some(cred => cred.id === assertionId);

                // if (credentialExists) {
                //     outputDiv.textContent = 'Passkey 验证成功！\n凭证 ID: ' + assertionId;
                // } else {
                //     outputDiv.textContent = 'Passkey 验证失败：凭证不存在。';
                // }
            } catch (err) {
                console.error(err);
                outputDiv.textContent = '验证 Passkey 失败：' + err.message;
            }
        });

        // 生成随机 Base64 字符串
        function generateRandomBase64(length) {
            const array = new Uint8Array(length);
            window.crypto.getRandomValues(array);
            return bufferToBase64(array.buffer);
        }
    </script>
</body>
</html>

